{% extends "main/base.html" %}
{% load form_tags %}
{% block title %}Score Report{% endblock %}
{% block content %}

<div class="container mt-5">
    <h2 class="mb-4">Score Report</h2>
    
    <div id="alert-container">
        {% if error_message %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                {{ error_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endif %}
    </div>

    <div class="container my-3">
        <button class="btn btn-primary mb-2" type="button" id="filterToggleBtn" data-bs-toggle="collapse" data-bs-target="#filterPanel" aria-expanded="true" aria-controls="filterPanel">
            Show Filters
        </button>

        <div class="collapse show" id="filterPanel">
            <div class="card card-body">
            <form method="get" action="" id="filterForm">
                <div class="row g-3">
                    <div class="col-md-2">
                        <label for="report_type" class="form-label">Report Type</label>
                        <select class="form-select" name="report_type" id="report_type">
                            <option value="1" {% if filters.report_type == "1" %}selected{% endif %}>Student</option>
                            <option value="2" {% if filters.report_type == "2" %}selected{% endif %}>Team</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="simulation_id" class="form-label">Simulation</label>
                        <select class="form-select" name="simulation_id" id="simulation_id">
                            <option value="">All</option>
                            {% if simulation_list %}
                                {% for simulation in simulation_list %}
                                    <option value="{{simulation.id}}" {% if filters.simulation_id|stringformat:"s" == simulation.id|stringformat:"s" %}selected{% endif %}>{{simulation.name}}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="market_id" class="form-label">Market</label>
                        <select class="form-select" name="market_id" id="market_id">
                            <option value="">All</option>
                            {% if market_list %}
                                {% for market in market_list %}
                                    <option value="{{market.id}}" {% if filters.market_id|stringformat:"s" == market.id|stringformat:"s" %}selected{% endif %}>{{market.name}}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="campus" class="form-label">Campus</label>
                        <select class="form-select" name="campus" id="campus">
                            <option value="">All</option>
                            {% if campus_list %}
                                {% for campus in campus_list %}
                                    <option value="{{campus.campus}}" {% if filters.campus == campus.campus %}selected{% endif %}>{{campus.campus}}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="student_name" class="form-label">Student Name</label>
                        <input type="text" class="form-control" name="student_name" id="student_name" value="{{ filters.student_name }}">
                    </div>
                    <div class="col-md-2">
                        <label for="gender" class="form-label">Gender</label>
                        <select class="form-select" name="gender" id="gender">
                            <option value="">All</option>
                            <option value="Male" {% if filters.gender == 'Male' %}selected{% endif %}>Male</option>
                            <option value="Female" {% if filters.gender == 'Female' %}selected{% endif %}>Female</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="age_from" class="form-label">Age From</label>
                        <input type="number" class="form-control" name="age_from" id="age_from" value="{{ filters.age_from }}">
                    </div>
                    <div class="col-md-2">
                        <label for="age_to" class="form-label">Age To</label>
                        <input type="number" class="form-control" name="age_to" id="age_to" value="{{ filters.age_to }}">
                    </div>
                    <div class="col-md-2">
                        <label for="per_page" class="form-label">Per Page Item</label>
                        <input type="number" class="form-control" name="per_page" id="per_page" value="{{ filters.per_page }}">
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <button type="submit" class="btn btn-success me-2">Apply Filters</button>
                        <a href="?" class="btn btn-secondary me-2">Reset</a>
                        <button type="button" id="exportBtn" class="btn btn-primary me-2">Export</button>
                    </div>
                </div>
            </form>
            </div>
        </div>
        </div>

    <p>Total students: {{ total_rows }}</p>
    <!-- Table -->
    <div class="table-responsive">
        <table class="table table-bordered table-striped" id="marketTable">
            <thead class="table-dark">
                <tr>
                    <th>Sl</th>
                    <th>Market</th>
                    <th>Student Name</th>
                    <th>Age</th>
                    <th>Gender</th>
                    <th>Campus</th>
                    <th>Subscription Key</th>
                    <th>Simulation Number</th>
                    <th>Rubric(%)</th>
                    <th>Balanced(%)</th>
                    <th>Participation(%)</th>
                    <th>Rank(%)</th>
                    <th>HR(%)</th>
                    <th>Ethics</th>
                    <th>Competency Quiz(%)</th>
                    <th>Team Evaluation(%)</th>
                    <th>Period joined</th>
                    <th>Tutorial Quiz(%)</th>
                    <th>Operation</th>
                </tr>
            </thead>
            <tbody>
                {% for obj in page_obj %}
                <tr id="item-row-{{ obj.id }}">
                    <td>{{ forloop.counter0|add:page_obj.start_index|add:-0 }}</td>
                    <td title="{{ obj.market_name }}">{{ obj.market_name|slice:":10" }}{% if obj.market_name|length > 6 %}â€¦{% endif %}</td>
                    <td>{{ obj.name }}</td>
                    <td>{{ obj.age }}</td>
                    <td>{{ obj.gender }}</td>
                    <td>{{ obj.campus }}</td>
                    <td>{{ obj.go_venture_subscription_key }}</td>
                    <td>{{ obj.go_venture_simulation_number }}</td>
                    <td>{{ obj.rubric_score_percentage }}</td>
                    <td>{{ obj.balanced_score_percentage }}</td>
                    <td>{{ obj.participation_percentage }} ({{ obj.participation_in }} of {{ obj.participation_total }})</td>
                    <td>{{ obj.rank_score_percentage }}</td>
                    <td>{{ obj.hr_score_percentage }}</td>
                    <td>{{ obj.ethics_score_percentage }}</td>
                    <td>{{ obj.competency_quiz_percentage }}</td>
                    <td>{{ obj.team_evaluation_percentage }}</td>
                    <td>{{ obj.period_joined }}</td>
                    <td>{{ obj.tutorial_quiz_percentage }}</td>
                    <td>-</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-center">No item found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if page_obj.has_other_pages %}
    <!-- Pagination -->
    <nav>
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">Previous</span></li>
            {% endif %}

            <li class="page-item disabled">
                <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            </li>

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>


<div id="overlay" style="display:none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
{% endblock %}


{% block script %}
<script>
    $(document).ready(function () {

        var $filterPanel = $('#filterPanel');
        var $toggleBtn = $('#filterToggleBtn');

        // Bootstrap 5 collapse events
        $filterPanel.on('show.bs.collapse', function () {
            $toggleBtn.text('Hide Filters');
        });

        $filterPanel.on('hide.bs.collapse', function () {
            $toggleBtn.text('Show Filters');
        });

        // Initial text based on panel state
        if ($filterPanel.hasClass('show')) {
            $toggleBtn.text('Hide Filters');
        } else {
            $toggleBtn.text('Show Filters');
        }

         $('#simulation_id').change(function () {
            var simulation_id = $(this).val();
            const formData = new FormData();
            formData.append("simulation_id", simulation_id);
            $.ajax({
                url: "{% url 'getMarketsList' %}",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                beforeSend: function(){
                    $("#overlay").show();
                },
                success: function (response) {
                    if (response.success) {
                        $("#market_id").empty().append('<option value="">All market</option>');
                        response.markets.forEach(obj => {
                            $("#market_id").append(`<option value="${obj.id}">${obj.name}</option>`);
                        });
                    } else {
                        $("#message").html(`<div class='alert alert-danger'>${response.error.replace(/\n/g, "<br>")}</div>`);
                    }
                },
                error: function () {
                    $("#message").html(`<div class='alert alert-danger'>Error uploading file.</div>`);
                },
                complete: function(){
                     $("#overlay").hide();
                }
            });
         });

        $("#exportBtn").click(function() {
            var $form = $("#filterForm");

            // Store original action
            var originalAction = $form.attr("action") || "";

            // Change form action to Excel export URL
            $form.attr("action", "{% url 'studentScoreReportXlx' %}");

            // Submit the form
            $form.submit();

            // Restore original action
            $form.attr("action", originalAction);
        });
    });

</script>
{% endblock %}