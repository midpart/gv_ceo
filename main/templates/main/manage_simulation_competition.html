{% extends "main/base.html" %}
{% load form_tags %}
{% block title %}Manage Simulations{% endblock %}
{% block content %}

<div class="container mt-5">
    <h2 class="mb-4">Manage Simulation Competition</h2>
    <!-- Add button -->
    <a href="{% url 'simulationCompetitionAdd' %}" class="btn btn-primary mb-3">
        + Add Simulation Competition
    </a>
    <div id="alert-container"></div>

    <!-- Table -->
    <table class="table table-bordered table-striped" id="simulationTable">
        <thead class="table-dark">
            <tr>
                <th>Sl</th>
                <th>ID</th>
                <th>Simulation Name</th>
                <th>Simulation Number</th>
                <th>Name</th>
                <th>Creation Datetime</th>
                <th>Modification Datetime</th>
                <th>Created By</th>
                <th>Modified By</th>
                <th>Operation</th>
            </tr>
        </thead>
        <tbody>
            {% for obj in page_obj %}
            <tr id="item-row-{{ obj.id }}">
                <td>{{ forloop.counter0|add:page_obj.start_index|add:-1 }}</td>
                <td>{{ obj.id }}</td>
                <td>{{ obj.simulation.name }}</td>
                <td>{{ obj.simulation_number }}</td>
                <td>{{ obj.name }}</td>
                <td>{{ obj.creation_date_time }}</td>
                <td>{{ obj.modification_date_time }}</td>
                <td>{{ obj.created_by }}</td>
                <td>{{ obj.modified_by }}</td>
                <td>
                    <a href="{% url 'simulationCompetitionEdit' obj.id %}" class="btn btn-primary btn-sm">Edit</a>
                    <button class="btn btn-danger btn-sm delete-btn" data-id="{{ obj.id }}">Delete</button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="10" class="text-center">No item found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% if page_obj.has_other_pages %}
    <!-- Pagination -->
    <nav>
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">Previous</span></li>
            {% endif %}

            <li class="page-item disabled">
                <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            </li>

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>


<div id="overlay" style="display:none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
{% endblock %}


{% block script %}
<script>
    $(document).ready(function () {
        function showAlert(message, type = 'success') {
            const alertHtml = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    `;
            $('#alert-container').html(alertHtml);
        }

        $('.delete-btn').click(function () {
            let objId = $(this).data('id');
            if (confirm('Are you sure you want to delete this item?')) {
                $.ajax({
                    url: `/simulation_competition/delete/${objId}/`,
                    type: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                    beforeSend: function(){
                        $("#overlay").show();
                    },
                    success: function (response) {
                        if (response.success) {
                            $('#item-row-' + objId).fadeOut(500, function () { $(this).remove(); });
                            showAlert(response.message, 'success');
                        } else {
                            showAlert(response.message, 'danger');
                        }
                    },
                    error: function () {
                        showAlert('An unexpected error occurred. Please try again.', 'danger');
                    },
                    complete: function(){
                        $("#overlay").hide();
                    }
                });
            }
        });
    });

</script>
{% endblock %}